@page "/admin/gatekeeper"
@using Microsoft.AspNetCore.Authorization
@using PosSystem.Permissions
@using PosSystem.Services
@using PosSystem.Data
@using PosSystem.Data.Entities
@using Microsoft.EntityFrameworkCore
@inject QrCoreService QrService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize(Policy = AppPermissions.Facilities.Gatekeeper)]
<MudContainer MaxWidth="MaxWidth.Small" Class="mt-4">
    <MudText Typo="Typo.h5" Class="mb-4 text-center">Gatekeeper Validation</MudText>

    <MudPaper Elevation="4" Class="rounded-lg overflow-hidden">
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Centered="true">

            @* TAB 1: SCANNER *@
            <MudTabPanel Text="Scan QR" Icon="@Icons.Material.Filled.QrCodeScanner">
                <div class="d-flex flex-column align-center">
                    <MudTextField @bind-Value="scanBuffer"
                                  Label="Scan QR Code"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.QrCodeScanner"
                                  OnKeyDown="HandleKeyDown"
                                  Immediate="true"
                                  AutoFocus="true"
                                  @ref="inputField"
                                  Class="mb-4"
                                  FullWidth="true" />

                    @if (isProcessing)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
                    }

                    @if (lastResult != null)
                    {
                        <MudAlert Severity="@lastResult.Severity" Variant="Variant.Filled" Class="mt-4 animate-fade" style="width:100%;">
                            <MudText Typo="Typo.h6">@lastResult.Title</MudText>
                            <MudText Typo="Typo.body2">@lastResult.Message</MudText>
                        </MudAlert>
                    }
                </div>
            </MudTabPanel>

        </MudTabs>
    </MudPaper>
</MudContainer>

@code {
    private string scanBuffer = "";
    private bool isProcessing = false;
    private ValidationResult? lastResult;
    private MudTextField<string>? inputField;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && inputField != null) await inputField.FocusAsync();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrEmpty(scanBuffer))
        {
            await ProcessScan(scanBuffer);
            scanBuffer = "";
            if (inputField != null) await inputField.FocusAsync();
        }
    }

    private async Task ProcessScan(string rawUrl)
    {
        isProcessing = true;
        lastResult = null;
        StateHasChanged();

        try
        {
            // 1. Clean URL
            string encryptedData = rawUrl;
            if (rawUrl.Contains("data="))
            {
                var uri = new Uri(rawUrl);
                var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
                encryptedData = query.Get("data") ?? rawUrl;
            }

            // 2. Decrypt
            var (type, id, isValid) = QrService.VerifyQrData(encryptedData);

            if (!isValid)
            {
                lastResult = new ValidationResult("INVALID", "Fake or corrupted QR code.", Severity.Error);
            }
            else
            {
                using var db = await DbFactory.CreateDbContextAsync();

                // --- SCENARIO A: MEMBER ENTRY (New!) ---
                if (type == "Member")
                {
                    var member = await db.Members.FirstOrDefaultAsync(m => m.QrToken == id);

                    if (member == null)
                    {
                        lastResult = new ValidationResult("NOT FOUND", "Member not found in database.", Severity.Warning);
                    }
                    else if (!member.IsActive)
                    {
                        lastResult = new ValidationResult("SUSPENDED", "Membership is inactive.", Severity.Error);
                    }
                    else if (member.ExpiryDate.HasValue && member.ExpiryDate.Value < DateTime.UtcNow)
                    {
                        lastResult = new ValidationResult("EXPIRED", $"Plan ended on {member.ExpiryDate:dd MMM}", Severity.Error);
                    }
                    else
                    {
                        // Log Visit
                        db.MemberVisits.Add(new MemberVisit
                        {
                            Id = Guid.NewGuid().ToString(),
                            MemberId = member.Id,
                            VisitTime = DateTime.UtcNow,
                            EntryGate = "Gatekeeper Terminal",
                            TenantId = member.TenantId
                        });
                        await db.SaveChangesAsync();

                        // Success Message
                        string expiryText = member.ExpiryDate.HasValue
                            ? $"Valid until {member.ExpiryDate:dd MMM}"
                            : "Lifetime Member";

                        lastResult = new ValidationResult("WELCOME", $"{member.Name}\n{expiryText}", Severity.Success);
                    }
                }
                // --- SCENARIO B: SINGLE TICKET ---
                else if (type == "Ticket")
                {
                    var ticket = await db.FacilityTickets.Include(t => t.Product).FirstOrDefaultAsync(t => t.Id == id);
                    if (ticket != null && !ticket.IsUsed)
                    {
                        ticket.IsUsed = true;
                        ticket.UsedAt = DateTime.UtcNow;
                        await db.SaveChangesAsync();
                        lastResult = new ValidationResult("ACCESS GRANTED", $"{ticket.Product?.Name} Verified!", Severity.Success);
                    }
                    else if (ticket != null && ticket.IsUsed)
                    {
                        lastResult = new ValidationResult("USED", $"Already used at {ticket.UsedAt:HH:mm}", Severity.Error);
                    }
                    else
                    {
                        lastResult = new ValidationResult("NOT FOUND", "Ticket invalid.", Severity.Warning);
                    }
                }
                else
                {
                    lastResult = new ValidationResult("UNKNOWN TYPE", $"QR Type '{type}' not supported.", Severity.Warning);
                }
            }
        }
        catch (Exception ex)
        {
            lastResult = new ValidationResult("ERROR", ex.Message, Severity.Error);
        }

        isProcessing = false;
        StateHasChanged();
    }

    private class ValidationResult
    {
        public string Title { get; }
        public string Message { get; }
        public Severity Severity { get; }
        public ValidationResult(string t, string m, Severity s) { Title = t; Message = m; Severity = s; }
    }
}