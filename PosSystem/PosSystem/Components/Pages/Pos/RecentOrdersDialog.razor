@using PosSystem.Data
@using PosSystem.Data.Entities
@using Microsoft.EntityFrameworkCore
@using PosSystem.Services

@inject IDbContextFactory<LocalDbContext> LocalDbFactory
@inject IDbContextFactory<ApplicationDbContext> CloudDbFactory
@inject ReceiptService ReceiptPrinter
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudGrid Class="mb-3" Spacing="2">
            @* 1. QUICK FILTER DROPDOWN *@
            <MudItem xs="4">
                <MudSelect T="string" Label="Quick Filter" ValueChanged="OnQuickFilterChanged"
                           Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@("Today")">Today</MudSelectItem>
                    <MudSelectItem Value="@("Yesterday")">Yesterday</MudSelectItem>
                    <MudSelectItem Value="@("Week")">Last 7 Days</MudSelectItem>
                    <MudSelectItem Value="@("Month")">Last 30 Days</MudSelectItem>
                </MudSelect>
            </MudItem>

            @* 2. MANUAL DATE PICKER *@
            <MudItem xs="5">
                <MudDateRangePicker Label="Custom Range" @bind-DateRange="_dateRange"
                                    Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>

            @* 3. SEARCH BUTTON *@
            <MudItem xs="3" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadOrders" FullWidth="true">Search</MudButton>
            </MudItem>
        </MudGrid>

        @if (_loading)
        {
            <div class="d-flex justify-center pa-4">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            </div>
        }
        else if (!_orders.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-2">
                No orders found for this period.
            </MudAlert>
        }
        else
        {
            <MudTable Items="_orders" Hover="true" Dense="true" Striped="true" Height="400px" Elevation="0" Class="mt-2">
                <HeaderContent>
                    <MudTh>Time</MudTh>
                    <MudTh>Order #</MudTh>
                    <MudTh>Amount</MudTh>
                    <MudTh>Payment</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Time">@context.CreatedAt.ToLocalTime().ToString("dd/MM HH:mm")</MudTd>
                    <MudTd DataLabel="Order #">@context.OrderNumber</MudTd>
                    <MudTd DataLabel="Amount"><b>@context.TotalAmount.ToString("N2")</b></MudTd>
                    <MudTd DataLabel="Payment">@context.PaymentMethod</MudTd>
                    <MudTd DataLabel="Status">
                        @if (context.IsSynced)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CloudDone" Color="Color.Success" Size="Size.Small" Title="Synced" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CloudOff" Color="Color.Warning" Size="Size.Small" Title="Local Only" />
                        }
                    </MudTd>
                    <MudTd>
                        <MudTooltip Text="Print Receipt">
                            <MudIconButton Icon="@Icons.Material.Filled.Print" Size="Size.Small" OnClick="@(() => PrintOrder(context))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    [Parameter] public string UnitId { get; set; } = "";

    // Default to "Last 7 Days" so you see data immediately
    private DateRange _dateRange = new DateRange(DateTime.Now.AddDays(-7).Date, DateTime.Now.Date);
    private List<Order> _orders = new();
    private bool _loading = false;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(UnitId)) return;
        await LoadOrders();
    }

    // --- NEW QUICK FILTER LOGIC ---
    private async Task OnQuickFilterChanged(string filter)
    {
        var today = DateTime.Now.Date;

        if (filter == "Today")
            _dateRange = new DateRange(today, today);
        else if (filter == "Yesterday")
            _dateRange = new DateRange(today.AddDays(-1), today.AddDays(-1));
        else if (filter == "Week")
            _dateRange = new DateRange(today.AddDays(-7), today);
        else if (filter == "Month")
            _dateRange = new DateRange(today.AddDays(-30), today);

        // Auto-refresh list after selection
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        _loading = true;
        try
        {
            var start = _dateRange.Start?.Date ?? DateTime.Now.Date;
            // Fix: Include full end day (23:59:59)
            var end = _dateRange.End?.Date.AddDays(1).AddTicks(-1) ?? DateTime.Now.Date.AddDays(1).AddTicks(-1);

            using var localDb = await LocalDbFactory.CreateDbContextAsync();

            _orders = await localDb.Orders
                .Where(o => o.UnitId == UnitId && o.CreatedAt >= start && o.CreatedAt <= end)
                .Include(o => o.OrderItems) // Critical for printing
                .OrderByDescending(o => o.CreatedAt)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Load Failed: " + ex.Message, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task PrintOrder(Order order)
    {
        try
        {
            if (order.OrderItems == null || !order.OrderItems.Any())
            {
                Snackbar.Add("Cannot print: Order items missing.", Severity.Warning);
                return;
            }
            await ReceiptPrinter.PrintAsync(order, "Store Copy", "");
            Snackbar.Add("Receipt Sent", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Print Error: " + ex.Message, Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();
}