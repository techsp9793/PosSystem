@page "/user/profile"
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@using PosSystem.Data
@using System.IO
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IWebHostEnvironment Environment
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDbContextFactory<ApplicationDbContext> DbFactory

@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>My Profile</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true" Class="mb-6">Account Settings</MudText>

    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">

            <MudTabPanel Text="Profile Details" Icon="@Icons.Material.Filled.Person">
                <EditForm Model="Input" OnValidSubmit="UpdateProfileAsync" FormName="profile-form">
                    <DataAnnotationsValidator />

                    <MudGrid>
                        <MudItem xs="12" sm="4" Class="d-flex flex-column align-center justify-center">
                            <MudAvatar Style="height:120px; width:120px; font-size:3rem;" Color="Color.Primary" Class="mb-4">
                                @if (!string.IsNullOrEmpty(AvatarUrl))
                                {
                                    <MudImage Src="@AvatarUrl" ObjectFit="ObjectFit.Cover" Style="height:100%; width:100%;" />
                                }
                                else
                                {
                                    @username?.FirstOrDefault().ToString().ToUpper()
                                }
                            </MudAvatar>

                            <MudFileUpload T="IBrowserFile" FilesChanged="UploadFile">
                                <ActivatorContent>
                                    <MudButton Variant="Variant.Outlined"
                                               StartIcon="@Icons.Material.Filled.CloudUpload"
                                               Color="Color.Primary">
                                        Change Photo
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>
                        </MudItem>

                        <MudItem xs="12" sm="8">
                            <MudStack Spacing="3">
                                <MudTextField @bind-Value="username" Label="Username" Variant="Variant.Outlined" ReadOnly="true" Disabled="true" />

                                <MudTextField @bind-Value="Input.PhoneNumber"
                                              Label="Phone Number"
                                              Variant="Variant.Outlined"
                                              HelperText="Visible to other admins" />
                                <ValidationMessage For="() => Input.PhoneNumber" />

                                <MudButton ButtonType="ButtonType.Submit"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           Class="mt-2"
                                           Size="Size.Large">
                                    Save Profile
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </EditForm>
            </MudTabPanel>

            <MudTabPanel Text="Security" Icon="@Icons.Material.Filled.Lock">
                <EditForm Model="PasswordInput" OnValidSubmit="ChangePasswordAsync" FormName="password-form">
                    <DataAnnotationsValidator />

                    <MudStack Spacing="3" Style="max-width: 500px;">
                        <MudTextField @bind-Value="PasswordInput.OldPassword"
                                      Label="Current Password"
                                      InputType="InputType.Password"
                                      Variant="Variant.Outlined" />
                        <ValidationMessage For="() => PasswordInput.OldPassword" />

                        <MudTextField @bind-Value="PasswordInput.NewPassword"
                                      Label="New Password"
                                      InputType="InputType.Password"
                                      Variant="Variant.Outlined" />
                        <ValidationMessage For="() => PasswordInput.NewPassword" />

                        <MudTextField @bind-Value="PasswordInput.ConfirmPassword"
                                      Label="Confirm New Password"
                                      InputType="InputType.Password"
                                      Variant="Variant.Outlined" />
                        <ValidationMessage For="() => PasswordInput.ConfirmPassword" />

                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Error">
                            Change Password
                        </MudButton>
                    </MudStack>
                </EditForm>
            </MudTabPanel>

        </MudTabs>
    }
</MudContainer>

@code {
    private string? currentUserId;
    private string? username;
    private string? AvatarUrl;
    private bool isLoading = true;

    private ProfileInputModel Input { get; set; } = new();
    private PasswordModel PasswordInput { get; set; } = new();

    // --- 1. SAFE LOAD (Uses Factory) ---
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        if (principal.Identity?.IsAuthenticated == true)
        {
            currentUserId = principal.FindFirstValue(ClaimTypes.NameIdentifier);

            // FIX: Use Factory to read data. This prevents collision with MainLayout.
            using var context = await DbFactory.CreateDbContextAsync();
            var dbUser = await context.Users.AsNoTracking().FirstOrDefaultAsync(u => u.Id == currentUserId);

            if (dbUser != null)
            {
                username = dbUser.UserName;
                Input.PhoneNumber = dbUser.PhoneNumber;
                AvatarUrl = dbUser.ProfilePictureUrl;
            }
        }
        isLoading = false;
    }

    // --- 2. UPLOAD LOGIC ---
    private async Task UploadFile(IBrowserFile file)
    {
        if (string.IsNullOrEmpty(currentUserId) || file == null) return;

        try
        {
            var folderPath = Path.Combine(Environment.WebRootPath, "uploads", "profiles");
            if (!Directory.Exists(folderPath)) Directory.CreateDirectory(folderPath);

            var fileName = $"{currentUserId}_{DateTime.Now.Ticks}{Path.GetExtension(file.Name)}";
            var diskPath = Path.Combine(folderPath, fileName);
            var webPath = $"/uploads/profiles/{fileName}";

            await using (var stream = new FileStream(diskPath, FileMode.Create))
            {
                await file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).CopyToAsync(stream);
            }

            // Safe DB Update
            using (var context = await DbFactory.CreateDbContextAsync())
            {
                var dbUser = await context.Users.FindAsync(currentUserId);
                if (dbUser != null)
                {
                    dbUser.ProfilePictureUrl = webPath;
                    await context.SaveChangesAsync();
                }
            }

            AvatarUrl = webPath;
            Snackbar.Add("Profile picture updated!", Severity.Success);

            await Task.Delay(1000);
            Navigation.Refresh(true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Upload failed: {ex.Message}", Severity.Error);
        }
    }

    // --- 3. SAFE UPDATE LOGIC ---
    private async Task UpdateProfileAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

        // FIX: Re-fetch the user here (MainLayout is done loading, so this is safe now)
        // We use UserManager here because SetPhoneNumberAsync requires a tracked entity
        var user = await UserManager.GetUserAsync(authState.User);

        if (user == null)
        {
            Snackbar.Add("Session expired.", Severity.Error);
            return;
        }

        if (Input.PhoneNumber != user.PhoneNumber)
        {
            var result = await UserManager.SetPhoneNumberAsync(user, Input.PhoneNumber);
            if (!result.Succeeded)
            {
                Snackbar.Add("Error updating phone number.", Severity.Error);
                return;
            }
            Snackbar.Add("Profile updated successfully.", Severity.Success);
            Navigation.Refresh(true);
        }
        else
        {
            Snackbar.Add("No changes detected.", Severity.Info);
        }
    }

    // --- 4. SAFE PASSWORD CHANGE ---
    private async Task ChangePasswordAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (user == null) return;

        var result = await UserManager.ChangePasswordAsync(user, PasswordInput.OldPassword, PasswordInput.NewPassword);

        if (result.Succeeded)
        {
            Snackbar.Add("Password changed successfully!", Severity.Success);
            PasswordInput = new();
            Navigation.Refresh(true);
        }
        else
        {
            foreach (var error in result.Errors)
            {
                Snackbar.Add(error.Description, Severity.Error);
            }
        }
    }

    public class ProfileInputModel
    {
        [Phone(ErrorMessage = "Invalid phone number format.")]
        public string? PhoneNumber { get; set; }
    }

    public class PasswordModel
    {
        [Required]
        public string OldPassword { get; set; } = "";

        [Required]
        [StringLength(100, MinimumLength = 6)]
        public string NewPassword { get; set; } = "";

        [Compare("NewPassword", ErrorMessage = "Passwords do not match.")]
        public string ConfirmPassword { get; set; } = "";
    }
}