@page "/auth/login-bridge"
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using PosSystem.Data
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation

<MudContainer Class="d-flex align-center justify-center" Style="height: 100vh;">
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    <MudText Typo="Typo.h6" Class="ms-3">Finalizing sign-in...</MudText>
</MudContainer>

@code {
    protected override async Task OnInitializedAsync()
    {
        // Get the URI and parse the query string manually
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);

        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("userId", out var userId))
        {
            var user = await UserManager.FindByIdAsync(userId!);
            if (user != null)
            {
                // This will now work because this page is NOT interactive
                await SignInManager.SignInAsync(user, isPersistent: true);
            }
        }

        // Force reload to dashboard to ensure the cookie is picked up
        Navigation.NavigateTo("/dashboard", forceLoad: true);
    }
}