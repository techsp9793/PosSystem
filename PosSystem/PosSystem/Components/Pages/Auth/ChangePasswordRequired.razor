@page "/auth/change-password-required"
@layout PublicLayout
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using PosSystem.Data
@using PosSystem.Components.Layout

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ILogger<ChangePasswordRequired> Logger

<PageTitle>Change Password Required</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex flex-column align-center justify-center" Style="min-height: 100vh;">
    <MudCard Elevation="4" Class="pa-8" Style="width: 100%; max-width: 400px;">
        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-2">Security Update</MudText>
        <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-6 text-muted">
            Because this is your first login, you must change your temporary password to secure your account.
        </MudText>

        <MudForm @ref="form" @bind-IsValid="@success">
            @* 1. Old Password (Security Check) *@
            <MudTextField @bind-Value="CurrentPassword"
                          Label="Current Password"
                          InputType="InputType.Password"
                          Variant="Variant.Outlined"
                          Required="true"
                          Class="mb-4" />

            @* 2. New Password *@
            <MudTextField @bind-Value="NewPassword"
                          Label="New Password"
                          InputType="InputType.Password"
                          Variant="Variant.Outlined"
                          Required="true"
                          HelperText="Must be at least 6 characters"
                          Class="mb-4" />

            @* 3. Confirm New Password *@
            <MudTextField @bind-Value="ConfirmPassword"
                          Label="Confirm New Password"
                          InputType="InputType.Password"
                          Variant="Variant.Outlined"
                          Required="true"
                          Validation="@(new Func<string, string?>(PasswordMatch))"
                          Class="mb-6" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       FullWidth="true"
                       OnClick="SubmitChange"
                       Disabled="@processing">
                @if (processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Updating...</MudText>
                }
                else
                {
                    <MudText>Update & Sign In</MudText>
                }
            </MudButton>
        </MudForm>
    </MudCard>
</MudContainer>

@code {
    [SupplyParameterFromQuery]
    public string? UserId { get; set; }

    private string CurrentPassword { get; set; } = "";
    private string NewPassword { get; set; } = "";
    private string ConfirmPassword { get; set; } = "";

    private bool success;
    private bool processing = false;
    private MudForm form = default!;

    private string? PasswordMatch(string arg)
    {
        if (NewPassword != arg) return "Passwords do not match";
        return null;
    }

    private async Task SubmitChange()
    {
        await form.Validate();
        if (!form.IsValid) return;

        if (string.IsNullOrEmpty(UserId))
        {
            Snackbar.Add("User ID missing. Please login again.", Severity.Error);
            Navigation.NavigateTo("/login");
            return;
        }

        processing = true;

        try
        {
            var user = await UserManager.FindByIdAsync(UserId);
            if (user == null)
            {
                Snackbar.Add("User not found.", Severity.Error);
                Navigation.NavigateTo("/login");
                return;
            }

            // 1. Change the Password
            var result = await UserManager.ChangePasswordAsync(user, CurrentPassword, NewPassword);

            if (result.Succeeded)
            {
                // 2. Remove the "MustChangePassword" claim so they don't get stuck in a loop
                var claims = await UserManager.GetClaimsAsync(user);
                var forceClaim = claims.FirstOrDefault(c => c.Type == "MustChangePassword");
                if (forceClaim != null)
                {
                    await UserManager.RemoveClaimAsync(user, forceClaim);
                }

                Snackbar.Add("Password updated successfully!", Severity.Success);

                // 3. Sign them in immediately
                Navigation.NavigateTo($"/auth/login-bridge?userId={user.Id}", forceLoad: true);
            }
            else
            {
                foreach (var error in result.Errors)
                {
                    Snackbar.Add(error.Description, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            processing = false;
        }
    }
}