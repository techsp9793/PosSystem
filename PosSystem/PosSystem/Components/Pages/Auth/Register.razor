@page "/register"
@layout PublicLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using PosSystem.Components.Layout
@using PosSystem.Data
@using PosSystem.Components.Shared
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ILogger<Register> Logger

<PageTitle>Register - MyPOS</PageTitle>

<AuthCard Title="Create Your Account">
    <EditForm Model="Input" OnValidSubmit="RegisterUser">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <AuthField Label="Email" Icon="@Icons.Material.Filled.Email"
                   @bind-Value="Input.Email" />

        <AuthField Label="Password" Icon="@Icons.Material.Filled.Lock"
                   InputType="@(showPassword ? InputType.Text : InputType.Password)"
                   @bind-Value="Input.Password" />

        <AuthField Label="Confirm Password" Icon="@Icons.Material.Filled.Lock"
                   InputType="@(showPassword ? InputType.Text : InputType.Password)"
                   @bind-Value="Input.ConfirmPassword" />

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Large"
                   FullWidth="true"
                   Class="mt-6"
                   ButtonType="ButtonType.Submit"
                   Disabled="@isLoading">
            @if (isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Registering...</span>
            }
            else
            {
                <span>Register</span>
            }
        </MudButton>
    </EditForm>

    <div class="text-center mt-6">
        <MudLink Href="/login">Already have an account? Log in</MudLink>
    </div>
</AuthCard>

@code {
    private bool showPassword = false;
    private InputModel Input { get; set; } = new();
    private bool isLoading = false;

    private async Task RegisterUser()
    {
        isLoading = true;

        try
        {
            var user = new ApplicationUser { UserName = Input.Email, Email = Input.Email };
            var result = await UserManager.CreateAsync(user, Input.Password);

            if (result.Succeeded)
            {
                await SignInManager.SignInAsync(user, isPersistent: false);
                Snackbar.Add("Account created successfully!", Severity.Success);
                Navigation.NavigateTo("/", true);
            }
            else
            {
                var errors = string.Join(Environment.NewLine, result.Errors.Select(e => e.Description));
                Snackbar.Add("Registration failed: " + errors, Severity.Error);
                Logger.LogWarning("Registration failed: {Errors}", errors);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("An unexpected error occurred. Please try again.", Severity.Error);
            Logger.LogError(ex, "Registration error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [StringLength(100, MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Required]
        [Compare(nameof(Password))]
        [DataType(DataType.Password)]
        public string ConfirmPassword { get; set; } = "";
    }
}