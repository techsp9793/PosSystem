@page "/"
@page "/login"
@layout PublicLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using PosSystem.Components.Layout
@using PosSystem.Data
@using PosSystem.Components.Shared
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILogger<WelcomeAuth> Logger
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject SignInManager<ApplicationUser> SignInManager
<PageTitle>@GetPageTitle() - MyPOS</PageTitle>
<MudDialogProvider />
<MudSnackbarProvider />
<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex flex-column align-center justify-center" Style="min-height: calc(100vh - 64px); padding: 2rem 1rem;">
    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-2 font-weight-bold">
        @GetHeaderTitle()
    </MudText>
    <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-8 text-muted">
        @GetHeaderSubtitle()
    </MudText>

    <!-- MOBILE SIGN IN CARD -->
    @if (activeCard == CardMode.Mobile)
    {
        <MudCard Elevation="6" Class="pa-8 mx-auto" Style="width: 100%; max-width: 420px; border-radius: 16px;">
            <MudText Typo="Typo.h6" Class="mb-4">Sign in with Mobile</MudText>

            <MudTextField Label="Mobile Number"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentText="+91"
                          Placeholder="Enter mobile number"
                          @bind-Value="Input.PhoneNumber"
                          Class="mb-6" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       FullWidth="true"
                       OnClick="SendOtp">
                Send OTP
            </MudButton>

            <MudDivider Class="my-6" />

            <MudStack Spacing="2" AlignItems="AlignItems.Center">
                <MudLink OnClick="() => activeCard = CardMode.Email" Color="Color.Primary">
                    Sign in with Email
                </MudLink>
                <MudLink OnClick="() => activeCard = CardMode.Social" Color="Color.Primary">
                    Sign in with Social Media
                </MudLink>
            </MudStack>
        </MudCard>
    }

    <!-- EMAIL SIGN IN CARD -->
    @if (activeCard == CardMode.Email)
    {
        <MudCard Elevation="6" Class="pa-8 mx-auto" Style="width: 100%; max-width: 420px; border-radius: 16px;">
            <MudText Typo="Typo.h6" Class="mb-4">Sign in with Email</MudText>

            <AuthField Label="Email"
                       Placeholder="Enter your email"
                       @bind-Value="Input.Email"
                       Class="mb-4" />

            <AuthField Label="Password"
                       Icon="@Icons.Material.Filled.Lock"
                       InputType="@(showPassword ? InputType.Text : InputType.Password)"
                       Placeholder="Enter your password"
                       Adornment="Adornment.End"
                       AdornmentIcon="@(showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                       OnAdornmentClick="() => showPassword = !showPassword"
                       @bind-Value="Input.Password"
                       Class="mb-2" />

            <div class="text-end mb-4">
                <MudLink Href="/forgot-password" Color="Color.Primary" Typo="Typo.body2">
                    Forgot Password?
                </MudLink>
            </div>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       FullWidth="true"
                       OnClick="LoginWithEmail">
                Sign In
            </MudButton>

            <MudDivider Class="my-6" />

            <MudStack Spacing="2" AlignItems="AlignItems.Center">
                <MudLink OnClick="() => activeCard = CardMode.Mobile" Color="Color.Primary">
                    Sign in with Mobile
                </MudLink>
                <MudLink OnClick="() => activeCard = CardMode.Social" Color="Color.Primary">
                    Sign in with Social Media
                </MudLink>
            </MudStack>
        </MudCard>
    }

    <!-- SOCIAL SIGN IN CARD -->
    @if (activeCard == CardMode.Social)
    {
        <MudCard Elevation="6" Class="pa-8 mx-auto" Style="width: 100%; max-width: 420px; border-radius: 16px;">
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-4">Continue with Social Media</MudText>

            <MudStack Spacing="2">
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Custom.Brands.Google"
                           Color="Color.Error"
                           FullWidth="true"
                           OnClick="LoginWithGoogle">
                    Continue with Google
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Custom.Brands.Facebook"
                           Color="Color.Info"
                           FullWidth="true"
                           OnClick="LoginWithFacebook">
                    Continue with Facebook
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Custom.Brands.WhatsApp"
                           Color="Color.Success"
                           FullWidth="true"
                           OnClick="LoginWithWhatsApp">
                    Continue with WhatsApp
                </MudButton>
            </MudStack>

            <MudDivider Class="my-6" />

            <MudStack Spacing="2" AlignItems="AlignItems.Center">
                <MudLink OnClick="() => activeCard = CardMode.Mobile" Color="Color.Primary">
                    Sign in with Mobile
                </MudLink>
                <MudLink OnClick="() => activeCard = CardMode.Email" Color="Color.Primary">
                    Sign in with Email
                </MudLink>
            </MudStack>
        </MudCard>
    }

    <!-- REGISTRATION CARD -->
    @if (activeCard == CardMode.Register)
    {
        <MudCard Elevation="6" Class="pa-8 mx-auto" Style="width: 100%; max-width: 420px; border-radius: 16px;">
            <MudText Typo="Typo.h6" Class="mb-4">Create Account</MudText>

            <AuthField Label="Full Name"
                       Placeholder="Enter your full name"
                       @bind-Value="Input.Name"
                       Class="mb-4" />

            <AuthField Label="Email"
                       Placeholder="Enter your email"
                       @bind-Value="Input.Email"
                       Class="mb-4" />

            <AuthField Label="Password"
                       Icon="@Icons.Material.Filled.Lock"
                       InputType="@(showPassword ? InputType.Text : InputType.Password)"
                       Placeholder="Create a password (min 6 characters)"
                       Adornment="Adornment.End"
                       AdornmentIcon="@(showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                       OnAdornmentClick="() => showPassword = !showPassword"
                       @bind-Value="Input.Password"
                       Class="mb-4" />

            <AuthField Label="Confirm Password"
                       Icon="@Icons.Material.Filled.Lock"
                       InputType="@(showPassword ? InputType.Text : InputType.Password)"
                       Placeholder="Confirm your password"
                       Adornment="Adornment.End"
                       AdornmentIcon="@(showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                       OnAdornmentClick="() => showPassword = !showPassword"
                       @bind-Value="Input.ConfirmPassword"
                       Class="mb-6" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       FullWidth="true"
                       OnClick="RegisterWithEmail">
                Create Account
            </MudButton>

            <MudDivider Class="my-6" />

            <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-4 text-muted">
                Or sign up with
            </MudText>

            <MudStack Row="true" Justify="Justify.Center" Spacing="3">
                <MudIconButton Icon="@Icons.Custom.Brands.Google"
                               Color="Color.Default"
                               Variant="Variant.Outlined"
                               Size="Size.Large"
                               OnClick="RegisterWithGoogle" />
                <MudIconButton Icon="@Icons.Custom.Brands.Facebook"
                               Color="Color.Default"
                               Variant="Variant.Outlined"
                               Size="Size.Large"
                               OnClick="RegisterWithFacebook" />
                <MudIconButton Icon="@Icons.Custom.Brands.WhatsApp"
                               Color="Color.Default"
                               Variant="Variant.Outlined"
                               Size="Size.Large"
                               OnClick="RegisterWithWhatsApp" />
            </MudStack>
        </MudCard>
    }

    <!-- TOGGLE BETWEEN LOGIN/REGISTER -->
    <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-6">
        @if (activeCard == CardMode.Register)
        {
            <text>Already have an account? </text>
            <MudLink OnClick="() => activeCard = CardMode.Mobile" Color="Color.Primary" Class="font-weight-bold">
                Sign In
            </MudLink>
        }
        else
        {
            <text>Don't have an account? </text>
            <MudLink OnClick="() => activeCard = CardMode.Register" Color="Color.Primary" Class="font-weight-bold">
                Create Account
            </MudLink>
        }
    </MudText>

    <!-- FOOTER -->
    <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-4 text-muted">
        By continuing, you agree to our
        <MudLink Href="/terms" Color="Color.Primary">Terms & Privacy Policy</MudLink>
    </MudText>
</MudContainer>

@code {
    private InputModel Input { get; set; } = new();
    private bool showPassword = false;
    private CardMode activeCard = CardMode.Mobile;
    private string generatedOtp = "";

    private string GetPageTitle() => activeCard switch
    {
        CardMode.Register => "Create Account",
        _ => "Sign In"
    };

    private string GetHeaderTitle() => activeCard switch
    {
        CardMode.Register => "Create Your Account",
        _ => "Welcome Back"
    };

    private string GetHeaderSubtitle() => activeCard switch
    {
        CardMode.Register => "Sign up to start using MyPOS",
        _ => "Sign in to continue to MyPOS"
    };

    private async Task SendOtp()
    {
        if (string.IsNullOrWhiteSpace(Input.PhoneNumber))
        {
            Snackbar.Add("Enter valid mobile number", Severity.Error);
            return;
        }

        generatedOtp = new Random().Next(100000, 999999).ToString();
        Logger.LogInformation("OTP sent to {Phone}: {Otp}", Input.PhoneNumber, generatedOtp);
        Snackbar.Add($"OTP sent! Code: {generatedOtp}", Severity.Success);

        var parameters = new DialogParameters
        {
            ["PhoneNumber"] = Input.PhoneNumber,
            ["GeneratedOtp"] = generatedOtp,
            ["OnVerificationComplete"] = EventCallback.Factory.Create<string>(this, HandleOtpVerification)
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = false,
            BackdropClick = false,
            CloseOnEscapeKey = false
        };

        var dialogReference = DialogService.Show<OtpVerificationDialog>("Verify OTP", parameters, options);
        await dialogReference.Result;
    }
    private async Task HandleOtpVerification(string otp)
    {
        var user = await UserManager.FindByNameAsync(Input.PhoneNumber);

        if (user == null)
        {
            user = new ApplicationUser
            {
                UserName = Input.PhoneNumber,
                PhoneNumber = Input.PhoneNumber
            };
            await UserManager.CreateAsync(user);
        }

        user.PhoneNumberConfirmed = true;
        await UserManager.UpdateAsync(user);
        Navigation.NavigateTo($"/auth/login-bridge?userId={user.Id}", forceLoad: true);
    }
    private async Task LoginWithEmail()
    {
        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user != null && await UserManager.CheckPasswordAsync(user, Input.Password))
        {
           
            Navigation.NavigateTo($"/auth/login-bridge?userId={user.Id}", forceLoad: true);
        }
        else
        {
            Snackbar.Add("Invalid email or password", Severity.Error);
        }
    }
   

    private async Task RegisterWithEmail()
    {
        if (string.IsNullOrWhiteSpace(Input.Name) || string.IsNullOrWhiteSpace(Input.Email) ||
            string.IsNullOrWhiteSpace(Input.Password))
        {
            Snackbar.Add("Please fill in all fields", Severity.Error);
            return;
        }

        if (Input.Password != Input.ConfirmPassword)
        {
            Snackbar.Add("Passwords do not match", Severity.Error);
            return;
        }

        if (Input.Password.Length < 6)
        {
            Snackbar.Add("Password must be at least 6 characters", Severity.Error);
            return;
        }

        var user = new ApplicationUser
        {
            UserName = Input.Email,
            Email = Input.Email
        };

        var result = await UserManager.CreateAsync(user, Input.Password);

        if (result.Succeeded)
        {
            await SignInManager.SignInAsync(user, isPersistent: false);
            Snackbar.Add("Account created successfully!", Severity.Success);
            Navigation.NavigateTo("/dashboard", true);
        }
        else
        {
            foreach (var error in result.Errors)
            {
                Snackbar.Add(error.Description, Severity.Error);
            }
        }
    }

    private async Task LoginWithGoogle()
    {
        Snackbar.Add("Google sign-in coming soon", Severity.Info);
    }

    private async Task LoginWithFacebook()
    {
        Snackbar.Add("Facebook sign-in coming soon", Severity.Info);
    }

    private async Task LoginWithWhatsApp()
    {
        Snackbar.Add("WhatsApp sign-in coming soon", Severity.Info);
    }

    private async Task RegisterWithGoogle()
    {
        Snackbar.Add("Google sign-up coming soon", Severity.Info);
    }

    private async Task RegisterWithFacebook()
    {
        Snackbar.Add("Facebook sign-up coming soon", Severity.Info);
    }

    private async Task RegisterWithWhatsApp()
    {
        Snackbar.Add("WhatsApp sign-up coming soon", Severity.Info);
    }

    private enum CardMode { Mobile, Email, Social, Register }

    private class InputModel
    {
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public string ConfirmPassword { get; set; } = "";
        public string PhoneNumber { get; set; } = "";
    }
}