@page "/"
@page "/login"
@layout PublicLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using PosSystem.Components.Layout
@using PosSystem.Data
@using PosSystem.Components.Shared
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ILogger<WelcomeAuth> Logger
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Sign In - MyPOS</PageTitle>
<MudDialogProvider />
<MudSnackbarProvider />

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex flex-column align-center justify-center" Style="min-height: calc(100vh - 64px); padding: 2rem 1rem;">
    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-2 font-weight-bold">
        Welcome Back
    </MudText>
    <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-8 text-muted">
        Sign in to continue to MyPOS
    </MudText>

    <MudCard Elevation="6" Class="pa-8 mx-auto" Style="width: 100%; max-width: 420px; border-radius: 16px;">
        <MudText Typo="Typo.h6" Class="mb-4">Sign In</MudText>

        @* MODIFIED: Label indicates both Email or Username *@
        <AuthField Label="Email or Username"
                   Placeholder="Enter email or username"
                   @bind-Value="Input.Login"
                   Class="mb-4" />

        <AuthField Label="Password"
                   Icon="@Icons.Material.Filled.Lock"
                   InputType="@(showPassword ? InputType.Text : InputType.Password)"
                   Placeholder="Enter your password"
                   Adornment="Adornment.End"
                   AdornmentIcon="@(showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                   OnAdornmentClick="() => showPassword = !showPassword"
                   @bind-Value="Input.Password"
                   Class="mb-2" />

        <div class="text-end mb-4">
            <MudLink Href="/forgot-password" Color="Color.Primary" Typo="Typo.body2">
                Forgot Password?
            </MudLink>
        </div>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Large"
                   FullWidth="true"
                   OnClick="LoginWithCredentials">
            Sign In
        </MudButton>

    </MudCard>

    <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-4 text-muted">
        By continuing, you agree to our
        <MudLink Href="/terms" Color="Color.Primary">Terms & Privacy Policy</MudLink>
    </MudText>
</MudContainer>

@code {
    private InputModel Input { get; set; } = new();
    private bool showPassword = false;

    private async Task LoginWithCredentials()
    {
        if (string.IsNullOrWhiteSpace(Input.Login) || string.IsNullOrWhiteSpace(Input.Password))
        {
            Snackbar.Add("Please enter login credentials", Severity.Warning);
            return;
        }

        // 1. Generate normalized versions for BOTH possibilities
        // (In case your system treats email normalization differently than username normalization)
        string normalizedEmailCandidate = UserManager.NormalizeEmail(Input.Login);
        string normalizedUserNameCandidate = UserManager.NormalizeName(Input.Login);

        // 2. Search directly in DB, IGNORING filters
        // We match the specific candidate against its specific column
        var user = await UserManager.Users
            .IgnoreQueryFilters()
            .FirstOrDefaultAsync(u => u.NormalizedEmail == normalizedEmailCandidate
                                   || u.NormalizedUserName == normalizedUserNameCandidate);
        if (user != null)
        {
            // 2. Check Password
            if (await UserManager.CheckPasswordAsync(user, Input.Password))
            {
                // 3. CHECK FOR FORCED PASSWORD CHANGE (Requirement #4 preparation)
                // We assume there is a Claim "MustChangePassword"
                var claims = await UserManager.GetClaimsAsync(user);
                if (claims.Any(c => c.Type == "MustChangePassword" && c.Value == "true"))
                {
                    // Navigate to change password page (You need to build this page)
                    // Pass ID or use a temp token logic
                    Navigation.NavigateTo($"/auth/change-password-required?userId={user.Id}");
                    return;
                }

                // 4. Success - Redirect via Bridge
                Navigation.NavigateTo($"/auth/login-bridge?userId={user.Id}", forceLoad: true);
                return;
            }
        }

        Snackbar.Add("Invalid login details", Severity.Error);
    }

    private class InputModel
    {
        // Renamed from Email to Login to reflect dual purpose
        public string Login { get; set; } = "";
        public string Password { get; set; } = "";
    }
}