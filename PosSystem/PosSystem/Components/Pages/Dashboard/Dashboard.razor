@page "/dashboard"
@using PosSystem.Services
@using Microsoft.AspNetCore.Authorization
@using PosSystem.Services
@attribute [Authorize]

@inject DashboardService DashboardService
@inject ITenantService TenantService

<PageTitle>Dashboard - MyPOS</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h5" Class="mb-4"><b>Dashboard</b></MudText>

    @if (isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else
    {
        <MudGrid>
            @* --- ROW 1: KEY METRICS --- *@

            @* 1. Daily Sales *@
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="3" Class="pa-4 d-flex flex-column align-center justify-center mud-width-full py-8">
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Success" Size="Size.Large" Class="mb-2" />
                    <MudText Typo="Typo.h4">@Stats.DailyRevenue.ToString("N0")</MudText>
                    <MudText Typo="Typo.subtitle2" Class="text-muted">Today's Revenue</MudText>
                </MudPaper>
            </MudItem>

            @* 2. Today's Visits (Gatekeeper) *@
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="3" Class="pa-4 d-flex flex-column align-center justify-center mud-width-full py-8">
                    <MudIcon Icon="@Icons.Material.Filled.DirectionsWalk" Color="Color.Info" Size="Size.Large" Class="mb-2" />
                    <MudText Typo="Typo.h4">@Stats.TodaysVisits</MudText>
                    <MudText Typo="Typo.subtitle2" Class="text-muted">Visitor Check-ins</MudText>
                </MudPaper>
            </MudItem>

            @* 3. Active Members *@
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="3" Class="pa-4 d-flex flex-column align-center justify-center mud-width-full py-8">
                    <MudIcon Icon="@Icons.Material.Filled.Groups" Color="Color.Primary" Size="Size.Large" Class="mb-2" />
                    <MudText Typo="Typo.h4">@Stats.ActiveMembers</MudText>
                    <MudText Typo="Typo.subtitle2" Class="text-muted">Active Members</MudText>
                </MudPaper>
            </MudItem>

            @* 4. Low Stock Alerts *@
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="3" Class="pa-4 d-flex flex-column align-center justify-center mud-width-full py-8"
                          Style="@(Stats.LowStockItems > 0 ? "border: 1px solid red;" : "")">
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Color="@(Stats.LowStockItems > 0 ? Color.Error : Color.Default)" Size="Size.Large" Class="mb-2" />
                    <MudText Typo="Typo.h4" Color="@(Stats.LowStockItems > 0 ? Color.Error : Color.Default)">@Stats.LowStockItems</MudText>
                    <MudText Typo="Typo.subtitle2" Class="text-muted">Low Stock Items</MudText>
                </MudPaper>
            </MudItem>

            @* --- ROW 2: CHARTS & ACTIONS --- *@

            <MudItem xs="12" md="8">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4">Weekly Sales Trend</MudText>
                    <MudChart ChartType="ChartType.Line" ChartSeries="@Series" XAxisLabels="@XAxisLabels" Width="100%" Height="300px" />
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Elevation="3" Class="pa-4" Style="height: 100%">
                    <MudText Typo="Typo.h6" Class="mb-4">Quick Actions</MudText>
                    <MudList T="string" Clickable="true">
                        <MudListItem Icon="@Icons.Material.Filled.PointOfSale" OnClick="@(() => Nav("/pos"))">
                            Open POS Register
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.PersonAdd" OnClick="@(() => Nav("/admin/members/register"))">
                            Register New Member
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.QrCodeScanner" OnClick="@(() => Nav("/admin/gatekeeper"))">
                            Gatekeeper Scanner
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.Inventory" OnClick="@(() => Nav("/inventory"))">
                            Check Inventory
                        </MudListItem>
                    </MudList>
                </MudPaper>
            </MudItem>

        </MudGrid>
    }
</MudContainer>

@inject NavigationManager Navigation

@code {
    private bool isLoading = true;
    private DashboardStats Stats = new();
    private List<ChartSeries> Series = new();
    private string[] XAxisLabels = { "Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6", "Today" };

    protected override async Task OnInitializedAsync()
    {
        var tenantId = TenantService.GetTenantId();

        // 1. Fetch Stats
        Stats = await DashboardService.GetStatsAsync(tenantId);

        // 2. Fetch Chart Data
        var weeklySales = await DashboardService.GetWeeklySalesDataAsync(tenantId);

        Series.Add(new ChartSeries { Name = "Sales", Data = weeklySales.ToArray() });

        // 3. Labels (Last 7 Days)
        XAxisLabels = Enumerable.Range(0, 7)
            .Select(i => DateTime.Now.AddDays(-6 + i).ToString("ddd"))
            .ToArray();

        isLoading = false;
    }

    private void Nav(string url)
    {
        Navigation.NavigateTo(url);
    }
}