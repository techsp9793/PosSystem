@using PosSystem.Client.Services
@using PosSystem.Client.Themes
@using Microsoft.AspNetCore.Http
@inject ThemeService ThemeService
@inject IHttpContextAccessor HttpContextAccessor
@implements IDisposable

@{
    var cookie = HttpContextAccessor.HttpContext?.Request.Cookies["isDarkMode"];
    bool isDark = cookie?.ToLower() == "true";
}

<!DOCTYPE html>
<html lang="en" class="@(isDark ? "dark-mode" : "")">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="PosSystem.styles.css" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />
    <HeadOutlet />

    <script>
        // Apply dark mode immediately if preference exists
        if (document.cookie.includes('isDarkMode=true') ||
            localStorage.getItem('isDarkMode') === 'true') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>
</head>
<body>
    @{
        if (!_isInitialized)
        {
            ThemeService.SetDarkMode(isDark);
        }
    }

    <MudThemeProvider Theme="@AppTheme.Default" IsDarkMode="@ThemeService.IsDarkMode" />
    <MudDialogProvider />
    <MudSnackbarProvider />
    <Routes @rendermode="InteractiveServer" />

    <script src="_framework/blazor.web.js"></script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
    <script src="~/js/site.js"></script>
    <script>
        window.updateThemeClass = (isDark) => {
            document.documentElement.classList.toggle('dark-mode', isDark);
        };
    </script>
</body>

@code {
        private bool _isInitialized = false;

        protected override void OnInitialized()
        {
                _isInitialized = true;
                ThemeService.OnChange += StateHasChanged;
        }

        public void Dispose() => ThemeService.OnChange -= StateHasChanged;
}
</html>